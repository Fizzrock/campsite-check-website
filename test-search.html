<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RIDB Facility Search Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        #search-form {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        input[type="text"], select, button {
            padding: 10px;
            font-size: 1em;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        button {
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #status {
            background-color: #eef7ff;
            border: 1px solid #b3d7f7;
            padding: 10px 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        #results ul {
            list-style-type: none;
            padding: 0;
        }
        #results li {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 4px;
        }
        #results li strong {
            color: #0056b3;
        }
    </style>
</head>
<body>

    <h1>RIDB Facility Search Test</h1>
    <p>This page tests the logic for fetching all pages of facility search results from the RIDB API via our secure serverless function and filtering them to show only campgrounds.</p>

    <div id="search-form">
        <label for="query">Search Term:</label>
        <input type="text" id="query" value="Rock Creek">

        <label for="state">State:</label>
        <select id="state"></select>

        <button id="search-btn">Search</button>
    </div>

    <div id="status">Enter a search term and click Search.</div>
    <div id="results"></div>

    <script>
        const queryInput = document.getElementById('query');
        const stateSelect = document.getElementById('state');
        const searchBtn = document.getElementById('search-btn');
        const statusDiv = document.getElementById('status');
        const resultsDiv = document.getElementById('results');

        // --- Populate State Dropdown ---
        const states = [
            'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
            'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
            'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
            'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
            'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
        ];
        states.forEach(state => {
            const option = document.createElement('option');
            option.value = state;
            option.textContent = state;
            if (state === 'CA') option.selected = true;
            stateSelect.appendChild(option);
        });

        // --- Main Search Logic ---
        searchBtn.addEventListener('click', performSearch);

        async function performSearch() {
            const query = queryInput.value.trim();
            const state = stateSelect.value;

            if (!query) {
                statusDiv.textContent = 'Please enter a search term.';
                return;
            }

            // Reset UI
            statusDiv.textContent = 'Searching...';
            resultsDiv.innerHTML = '';
            searchBtn.disabled = true;

            try {
                // 1. Make the initial API request for the first page
                const firstPageUrl = `/api/fetch-ridb?type=facilitySearch&query=${encodeURIComponent(query)}&state=${state}&limit=50&offset=0`;
                const response = await fetch(firstPageUrl);
                if (!response.ok) {
                    throw new Error(`API request failed with status: ${response.status}`);
                }
                const firstPageData = await response.json();

                let allFacilities = firstPageData.RECDATA || [];
                const totalCount = firstPageData.METADATA?.RESULTS?.TOTAL_COUNT || 0;
                const limit = 50;

                // 2. Check if more pages need to be fetched
                if (totalCount > limit) {
                    const totalPages = Math.ceil(totalCount / limit);
                    statusDiv.textContent = `Found ${totalCount} total results. Fetching all ${totalPages} pages...`;

                    const fetchPromises = [];
                    for (let i = 1; i < totalPages; i++) {
                        const offset = i * limit;
                        const pageUrl = `/api/fetch-ridb?type=facilitySearch&query=${encodeURIComponent(query)}&state=${state}&limit=${limit}&offset=${offset}`;
                        fetchPromises.push(fetch(pageUrl).then(res => res.json()));
                    }

                    // 3. Fetch all remaining pages concurrently
                    const otherPagesData = await Promise.all(fetchPromises);
                    otherPagesData.forEach(pageData => {
                        if (pageData.RECDATA) {
                            allFacilities = allFacilities.concat(pageData.RECDATA);
                        }
                    });
                }

                // 4. Filter the aggregated results to only include campgrounds
                const campgrounds = allFacilities.filter(facility =>
                    facility.FacilityTypeDescription === 'Campground'
                );

                // 5. Render the final list
                renderResults(campgrounds);
                statusDiv.textContent = `Search complete. Found ${campgrounds.length} campgrounds out of ${allFacilities.length} total facilities.`;

            } catch (error) {
                console.error('Search failed:', error);
                statusDiv.textContent = `Error: ${error.message}`;
            } finally {
                searchBtn.disabled = false;
            }
        }

        function renderResults(campgrounds) {
            if (campgrounds.length === 0) {
                resultsDiv.innerHTML = '<p>No campgrounds found matching your criteria.</p>';
                return;
            }

            const ul = document.createElement('ul');
            campgrounds.forEach(cg => {
                const li = document.createElement('li');
                
                // Attempt to find a parent organization name for context
                let parentOrgName = '';
                if (cg.ORGANIZATION && cg.ORGANIZATION.length > 0) {
                    parentOrgName = `(${cg.ORGANIZATION[0].OrgName})`;
                }

                li.innerHTML = `
                    <strong>${cg.FacilityName}</strong> ${parentOrgName}<br>
                    Facility ID: ${cg.FacilityID} | Type: ${cg.FacilityTypeDescription}
                `;
                ul.appendChild(li);
            });
            resultsDiv.appendChild(ul);
        }

    </script>

</body>
</html>